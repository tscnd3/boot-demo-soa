<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>websocket通讯</title>
</head>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
<script>
	var msgRecord;
    var socket;
    function openSocket() {
        if(typeof(WebSocket) == "undefined") {
            console.log("您的浏览器不支持WebSocket");
        }else{
            console.log("您的浏览器支持WebSocket");
            //实现化WebSocket对象，指定要连接的服务器地址与端口  建立连接
            //等同于socket = new WebSocket("ws://localhost:8888/xxxx/im/25");
            //var socketUrl="${request.contextPath}/im/"+$("#userId").val();
            var socketUrl="http://"+window.location.host+"/boot-demo-websocket/imserver/"+$("#userId").val();
            socketUrl=socketUrl.replace("https","ws").replace("http","ws");
            console.log(socketUrl);
            if(socket!=null){
                socket.close();
                socket=null;
            }
            socket = new WebSocket(socketUrl);
            //打开事件
            socket.onopen = function() {
                console.log("websocket已打开");
                //socket.send("这是来自客户端的消息" + location.href + new Date());
                showMsg("websocket已打开");
            };
            //获得消息事件
            socket.onmessage = function(msg) {
                console.log(msg.data);
                showMsg(msg.data);
              
            };
            //关闭事件
            socket.onclose = function() {
                console.log("websocket已关闭");
                showMsg("websocket已关闭");
            };
            //发生了错误事件
            socket.onerror = function() {
                console.log("websocket发生了错误");
                showMsg("websocket发生了错误");
            }
        }
    }
    function sendMessage() {
        if(typeof(WebSocket) == "undefined") {
            console.log("您的浏览器不支持WebSocket");
        }else {
            console.log("您的浏览器支持WebSocket");
            console.log('{"toUserId":"'+$("#toUserId").val()+'","contentText":"'+$("#contentText").val()+'"}');
            var msg='{"toUserId":"'+$("#toUserId").val()+'","contentText":"'+$("#contentText").val()+'"}';
            socket.send(msg);
            showMsg(msg);
        }
    }
    
    function showMsg(msg){
    	//	 msg='{"toUserId":"'+$("#toUserId").val()+'","contentText":"1231"}';
    	var s=isJSON(msg);
    	 console.log(s);
    	 if(s){
    		msg= eval('('+msg+')')
    		msg="用户："+msg['toUserId'] +"\n"+ msg['contentText'];	
    	 }
    	  if(msgRecord){
         	 msgRecord+=msg+"\n";
         }else{
         	msgRecord=msg+"\n";
         }
         $("#msgRecord").val(msgRecord);
    }
    
    function isJSON(str) {
        if (typeof str == 'string') {
            try {
                var obj=JSON.parse(str);
                if(typeof obj == 'object' && obj ){
                    return true;
                }else{
                    return false;
                }

            } catch(e) {
                console.log('error：'+str+'!!!'+e);
                return false;
            }
        }
        console.log('It is not a string!')
    }
    
</script>
<body>
		<div>
			<table>
				<tbody>
					<tr style="height:30px;">
						<th  style="width:120px; text-align: right;">消息接收送者：</th>
						<td><input id="toUserId" name="toUserId" type="text" placeholder="接收者用户Id"></td>
					</tr>	
					<tr style="height:30px;">
						<th style="width:120px; text-align:left;">消息记录</th>
						<td></td>
					</tr>
					<tr style="height:400px;"> 
						<td colspan="3">
							<textarea  style="height:370px; width:300px;" readonly="readonly" id="msgRecord" >
							</textarea>
						</td>
					</tr>
					<tr>
						<td colspan="3" style="padding-top: 0px;">
							<div style="padding-top: 100px;padding-bottom:20px;">
								<textarea  style="height:60px; width:300px; " id="contentText" name="contentText" >
								</textarea>
								<div style="float: right; padding-top: 20px; padding-left: 20px;"><input onclick="sendMessage();" type="button"  value="发送消息"></div>
							</div>
							
						</td>
					</tr>
					<tr style="height:30px;">
						<th style="width:120px; text-align:left;">消息发送者：</th>
						<th style="text-align:left;"><input id="userId" name="userId" type="text" placeholder="发送者用户Id"   ></th>
						<th><input type="button" value="开启socket" style="width: 100px; hight:30px;" onclick="openSocket()"/> </th>
					</tr>
				</tbody>
			</table>
			
		</div>
			






</body>

</html>